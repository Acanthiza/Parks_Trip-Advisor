---
title: "Analysis of Trip Advisor data relating to South Australian parks"
author:
- Department for Environment and Water
date: "`r format(Sys.time(), '%A, %d %B, %Y')`"
output:
  bookdown::gitbook:
    split_by: chapter
    toc_depth: 3
    css: style.css
    keep_md: no
csl:                          "common/BibStyle.csl"
bibliography:                 ["common/refs.bib","rPackages.bib","common/RC.bib"]
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, warning = FALSE, echo = FALSE, message = FALSE}

  useCores <- round(parallel::detectCores()*3/4,0)

  packages <- c("knitr"
                ,"bookdown"
                ,"tidyverse"
                ,"readxl"
                ,"fs"
                ,"lubridate"
                ,"rstan"
                ,"rstanarm"
                ,"ggridges"
                #,"tmap"
                ,"tidytext"
                ,"DT"
                )
  
  purrr::walk(packages,library,character.only=TRUE)
  
  write_bib(c("base",packages),file="rPackages.bib",tweak=TRUE)
  
  source("common/functions.R")
  
  # Set default chunk options (can adjust individual chunks differently if required)
  knitr::opts_chunk$set(warning = FALSE
                        , message = FALSE
                        , echo = FALSE
                        )
  
  options(knitr.kable.NA = "")
  
  # Set mapping defaults
  # tmap_options(basemaps = c("OpenStreetMap.Mapnik"
  #                           , "Esri.WorldImagery"
  #                           )
  #              )
  
  # reset ggplot default theme (rstanarm changes it for some reason)
  theme_set(theme_grey())
  
  # Project
  project <- basename(here::here())
  
```
  
```{r data}

  dat <- dir_info("data") %>%
    dplyr::filter(grepl("20190607",path)) %>%
    dplyr::mutate(data = map(path, read_excel)) %>%
    dplyr::select(data) %>%
    tidyr::unnest() %>%
    dplyr::mutate(User = gsub(" R.$","",User)
                  , Year = year(Date)
                  , Month = format(Date,"%B")
                  , month = as.numeric(format(Date,"%m"))
                  , Month = fct_reorder(Month,month)
                  , Yearmon = as_date(paste0("01/",Month,"/",Year),tz=Sys.timezone(),format="%d/%B/%Y")
                  , Age = gsub("18-34","18-24",age)
                  , id = row_number()
                  , reviews = n_distinct(id)
                  , Stars = as.numeric(Stars)
                  , Gender = gender
                  , Origin = if_else(Country == "Australia",State,Country)
                  , Text = paste0("Title: ",Title," - Review: ",Review)
                  , Park = if_else(grepl("Onkaparinga",Park),"Onkaparinga National Park",Park)
                  , Park = if_else(grepl("Flinders Ranges",Park),"Ikara-Flinders Ranges National Park",Park)
                  ) %>%
    dplyr::mutate_if(is.character,list(~gsub("^Null$|^Not given$|^null$|N/A",NA,.))) %>%
    dplyr::select(-month,-age,-gender) %>%
    dplyr::filter(!grepl("13",Age))

```

# Introduction

DEW manages many parks across South Australia. Some of these parks have a 'page' on [TripAdvisor](https://www.tripadvisor.com.au/). For example, there is a page for [Ikara-Flinders Ranges National Park](https://www.tripadvisor.com.au/Attraction_Review-g499711-d6456334-Reviews-Flinders_Ranges_National_Park-Hawker_Flinders_Ranges_South_Australia.html).

DEW are interested to know what information is contained in TripAdvisor reviews. Specifically, the following questions were identified by the community engagement branch:

* Where are visitors from:
     + Overall percentages – as in, of all the people who reviewed SA parks, 40 percent were Australian, 10 percent were English, 8 percent were American etc.
     + By park percentages – as in, of all the people who reviewed Belair National Park, 40 percent were Australian, 10 percent were English, 8 percent were American etc.
* What gender are visitors:
    + Overall percentages – as in, of all the people who reviewed SA parks, 45 percent were male and 55 percent were female
    + By park percentages – as in, of all the people who reviewed Belair national park, 45 percent were male and 55 percent were female
* What ages are visitors?
    + Overall
    + By individual park
* When are reviews made? (As in, in which month is the quantity of reviews submitted to Trip Advisor the highest? In which month is the quantity of reviews submitted to Trip Advisor the lowest?)
    + Overall
    + By individual park
* How does seasonality affect park ratings? (As in, parks receive most positive ratings in December and most negative ratings in May)
    + Overall
    + By individual park
* Are males or females more likely to rate parks positively or negatively?
    + Overall
    + By individual park
* Which country/state is more likely to rate parks positively or negatively?
    + Overall
    + By individual park
* Which age is more likely to rate parks positively or negatively?
    + Overall
    + By individual park
* Other possible questions
    + SA analysis – Adelaide vs regional views of parks
    + Multiple park reviews from one user:
    + Does reviewing more than one park lead to higher or lower ratings?
    + What parks are visited by people who review more than one park? Can we get a sense of itinerary from international visitors?
    
After an initial data exploration, these questions were treated as the following:

* What is the effect of age and gender on the rating given?
* What is the effect of the park visited on the rating given?
* What is the effect of the origin of a reviewer on the rating given?

These three analyses answer most of the questions posed by the community engagement branch but do not always examine interations, such as, say, the interaction of age and park on stars. This was done as sample size was very small for some groups, especially for low stars.

A further analysis of words used in the titles and reviews was also undertaken.

# Methods

## Data source

Data were taken from Trip Advisor. The site is one of the most popular sources of reviews for hotels, restaurants, experiences, attractions and places such as parks. Trip Advisor features user-generated content with 315 million reviewers (active and inactive) and about 500 million reviews [Wikipedia](https://en.wikipedia.org/wiki/TripAdvisor). 

For the purposes of this analysis, the search function in Trip Advisor was used to identify all parks, reserves and features in parks and reserves that have been reviewed. Some reviews were captured under a park name, such as "Flinders Chase National Park" and some were captured under a feature name, such as "Flinders Chase Visitor Centre". 

The web scraping software [Octoparse](https://www.octoparse.com/) was used to capture the following elements for analysis: 

* Reviewer name 
* Reviewer location (country, state and city) 
* Reviewer age 
* Reviewer gender 
* Review date 
* Review title 
* Review text 
* Review star rating 

Note that the web scraping software was able to effectively capture elements such as name, date, title, text and star rating, but that capturing the demographic information about the reviewers was a more difficult process. The demographic information is contained within "hover over" elements of the Trip Advisor web pages. Code was written to scrape these elements for the initial data scrape; manual cutting and pasting was used for scrape updates. It may be for this reason that most academic analysis of Trip Advisor reviews does not extend to considering demographic information and that this report may offer some new information about the utility of this data source. 

Once the data was captured it was cleaned so that it could be more easily used for qualitative analysis. The cleaning included:

* Ensuring that each review was attached to a unique reviewer name 
* Standardising place names to ensure that spellings were correct 
* Allocating state and/or countries to reviewers who gave only partial location information such as city of residence
* Ensuring that the data set contained no blank cells
* Removing reviewers under 18 years old (remove reviewers where the age field was equal to `13-17`)

## Workflow

This data analysis and report writing was done in a single scripted workflow (script file: [`r list.files(here::here(),pattern="Report.Rmd",recursive=TRUE)`](`r paste0("https://github.com/Acanthiza/",project,"/blob/master/",list.files(here::here(),pattern="t.Rmd",recursive=TRUE))`) using the programs 'R' and 'R-studio'.

[R](https://www.r-project.org/) [@R-base] is an open-source platform which makes available a library of packages that can be used and modified as necessary. [R-studio](https://www.rstudio.com/) provides a range of user-friendly features to facilitate interaction with R. The packages used are listed in the appendix: [R packages used] Table \@ref(tab:packages).

All data, code and outputs are stored in a version control system at [`r project`](`r paste0("https://github.com/Acanthiza/",project)`).

# Data exploration

## Summary

Between `r format(min(dat$Date),"%d/%B/%Y")` and `r format(max(dat$Date),"%d/%B/%Y")` there were `r nrow(dat)` reviews on TripAdvisor meeting the criteria outline in the [methods].

## Missing data

```{r dataMissing}

  datMiss <- dat %>%
    summarise_all(list(~sum(is.na(.)))) %>%
    t() %>%
    data.frame() %>%
    rownames_to_column() %>%
    dplyr::rename(column = 1, NAs = 2) %>%
    dplyr::mutate(per = 100*NAs/nrow(dat)
                  , column = fct_inorder(column)
                  )

```

Some of the key data fields were left blank in many reviews. For example, `r sum(is.na(dat$Gender))` (`r round(100*sum(is.na(dat$Gender))/nrow(dat),0)`%) reviews did not provide their gender and `r sum(is.na(dat$Age))` (`r round(100*sum(is.na(dat$Age))/nrow(dat),0)`%) didn't provide their age. Figure \@ref(fig:plotMissing) shows the percentage of reviews that did not provide information against each field.

```{r plotMissing, fig.cap = "A large proportion of reviews did not answer some questions, particularly Gender and Age"}

  ggplot(datMiss, aes(column,per)) +
    geom_col() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(x = "Column"
         , y = "Percentage of null (NA) cells in each column"
         )

```

## Count of reviews

```{r dataCount}
  
  datCount <- dat %>%
    dplyr::select(-Title,-Review,-Yearmon,-Date,-contains("URL")) %>%
    tidyr::gather(variable,value,1:ncol(.)) %>%
    dplyr::count(variable,value) 

```

There are several variables in the data with relatively few levels: `r vec_to_sentence(unique(pull(datCount,variable)),";")`. Figure \@ref(fig:plotDiscrete) shows the most frequently occuring values in each of those variables.

```{r plotDiscrete, fig.height = 12, fig.cap = "Most frequent values in each of the variables. Most reviews were from Adelaide based 50-64 year olds called Charmaine who visited Flinders Chase in January 2016 and gave it 5 stars"}
  
  ggplot(datCount %>%
           dplyr::filter(n > 4)%>%
           dplyr::group_by(variable) %>%
           dplyr::top_n(12) %>%
           dplyr::ungroup() %>%
           dplyr::mutate(value = fct_reorder(value,n))
         ) +
    geom_col(aes(value,n)) +
    facet_wrap(~variable, scales = "free",ncol=2) +
    coord_flip() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(x = "Value of variable"
         , y = "Count of value"
         )

```

# Model of stars (rating)

```{r model}

  modFile <- "out/model.rds"

  # variables to model
  varMod <- c("Y"
              , "time"
              , "Age"
              , "Gender"
              , "Park"
              , "Origin"
              )
  
  datMod <- dat %>%
    dplyr::filter(Year > 2011
                  , !is.na(Year)
                  , !is.na(Age)
                  , !is.na(Gender)
                  , !is.na(Park)
                  , !is.na(Origin)
                  ) %>%
    dplyr::add_count(Park) %>%
    dplyr::filter(n > 50) %>%
    dplyr::add_count(Origin) %>%
    dplyr::filter(n > 20) %>%
    dplyr::mutate(Y = Stars -1
                  , medYear = median(Year)
                  , time = Year - medYear
                  , State = fct_lump(State, n = 10)
                  , Park = fct_lump(Park, n = 10)
                  )
    
  if(file_exists(modFile)) {
    
    mod <- read_rds(modFile)
    
  } else {
    
    mod <-
      
      stan_glmer(
        as.formula(paste("cbind(Y,4-Y) ~ time*Gender*Age + (time|Park) + (time|Origin)")) #binomial
        , data = datMod
        , family = binomial
        #, chains = 5
        #, iter = 500
        , cores = useCores
      )
    
    saveRDS(mod,modFile)
    
  }

```

## Model

The effect of age, gender and year of review on the stars given were analysed using a Bayesian binomial generalised linear mixed model. The analysis was run using the rstanarm package [@RN4481] in R [@R-base]. Park (visited by reviewer) and Origin (of reviewer - state if reviewer was from Australia or country if not) were treated as random effects in the analysis. The `Feature/location` field was ignored for this analysis. The model specification was:

``r format(formula(mod))`` where `Y` is Stars-1. This required the model to estimate `r length(mod$coefficients)` parameters.

## Model diagnostics

Figure \@ref(fig:mixing) shows that each of the chains used to estimate model parameters converged around similar values for each parameter.

```{r mixing, fig.cap = "All chains converged around the same values for each of the model paramaters (first 10 shown here)"}

  stan_trace(mod)

```

---

Figure \@ref(fig:rhat) provides further support for convergence of the chains as no values are markedly different to 1.0.

```{r rhat, fig.cap = "Rhat values show no reason for concern"}

  plot(mod, "rhat_hist")

```

---

Figure \@ref(fig:fit) shows how (a sample of) the model runs (in light blue) compare with the original data (shown in dark blue).

```{r fit, fig.cap = "The model runs under estimate four stars and over estimate three stars relative to the data"}

  # Model fit
  pp_check(mod)

```

---

Figure \@ref(fig:meanVsSd) shows how the mean and standard deviation of the model runs (in light blue) compare with that of the original data (in dark blue).

```{r meanVsSd, fig.cap = "Collectively the model runs do a reasonable job estimating the data"}

  pp_check(mod, plotfun = "stat_2d", stat = c("mean", "sd"))

```

---

## Model predictions

### Age and gender

In order to better understand how the data and resulting model are able to inform management, a number (4000) of simulations were made based on the model results (strictly, draws were made from the posterior predictive distribution). Each simulation generated a prediction based on a single draw of the model parameters from their predicted distributions. Table \@ref(tab:predict) shows a summary of these results.

Figure \@ref(fig:modResult) shows a plot of the model results. Overwhelmingly, reviewers give 5 stars, irrespective of age or gender.

```{r predict}

  # Use the model to predict results over variables of interest
  modPred <- datMod %>%
    dplyr::select(Age,Gender) %>%
    unique() %>%
    dplyr::group_by(Age,Gender) %>%
    tidyr::expand(time = seq(min(datMod$time),max(datMod$time),1)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = unique(datMod$medYear)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Year = unique(.$medYear) + time
                  , Stars = value + 1
                  #, Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes <- as_tibble(modPred) %>%
    dplyr::group_by(Year,Age,Gender) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , Mean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.025)
                     , modci90up = quantile(Stars, 0.975)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(modMedian,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_if(is.numeric,round,2)
  
  kable(modRes %>%
          dplyr::select(Year,Age,Gender,Mean,`Median and range in 90% credible intervals`=text) %>%
          dplyr::group_by(Age,Gender) %>%
          dplyr::filter(Year == max(Year)) %>%
          dplyr::ungroup()
        , caption = "Summary of model results"
        )

```

---

```{r modResult, fig.cap = "Most reviewers give 5 stars irrespective of age or gender. Line is mean credible estimate and shading is 95% credible intervals. The lower 95% credible intervals go to three stars in almost every case - i.e. more than 95% of responses are three stars or more. Dots are original data points (jittered for clarity)"}

  ggplot(data=modRes,aes(Year,Mean,group=Age)) +
    geom_line() +
    geom_ribbon(aes(ymin = modci90lo, ymax = modci90up, fill = Age), alpha = 0.6) +
    geom_jitter(data = datMod
                , aes(Year,Stars,group=Age)
                , alpha=0.5
                , size =0.5
                , width = 0.1
                , height = 0.1
                ) +
    scale_colour_viridis_d() +
    scale_fill_viridis_d() +
    facet_grid(Age~Gender
               #, scales="free"
               ) +
    labs(y = "Stars"
         , subtitle = "Shading represents 95% credible intervals"
         )

```

### Park

Table \@ref(tab:predict2) shows a summary of predicted results for each Park. These results assume a population of reviewers split evenly among the levels of age, gender and year of review. Figure \@ref(fig:modResult2) shows a plot of the results for each park.

```{r predict2}

  # Use the model to predict results over variables of interest
  modPred2 <- datMod %>%
    dplyr::select(Age,Gender,Park) %>%
    unique() %>%
    dplyr::group_by(Age,Gender,Park) %>%
    tidyr::expand(time = seq(min(datMod$time),max(datMod$time),1)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = unique(datMod$medYear)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Year = unique(.$medYear) + time
                  , Stars = value + 1
                  #, Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes2 <- as_tibble(modPred2) %>%
    dplyr::group_by(Year,Park) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , Mean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.025)
                     , modci90up = quantile(Stars, 0.975)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(modMedian,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::left_join(datMod %>% dplyr::filter(Age == "35-49") %>% dplyr::count(Park) %>% dplyr::rename(reviews=n)) %>%
    dplyr::mutate_if(is.numeric,round,2) %>%
    dplyr::mutate(label = Park
                  , label = paste0(label,": ",reviews," reviews")
                  )
  
  modRes2Tab <- modRes2 %>%
          dplyr::select(Park,Year,Mean,`Median and range in 90% credible intervals`=text) %>%
          dplyr::group_by(Park) %>%
          dplyr::filter(Year == max(Year)) %>%
          dplyr::ungroup() %>%
          dplyr::mutate(Park = fct_reorder(Park,Mean,.desc = TRUE)) %>%
          dplyr::arrange(desc(Mean))
  
  kable(modRes2Tab
        , caption = paste0("Summary of model results for the last year with data. ", modRes2Tab %>% dplyr::top_n(2,Mean) %>% pull(Park) %>% vec_to_sentence(), " have the highest ratings (based on mean credible estimates)")
        )
  

```

---

```{r modResult2, fig.cap = "Line is mean credible estimate and shading is 95% credible intervals. Dots are original data points (jittered for clarity)"}

  ggplot(data=modRes2,aes(Year,Mean,fill=Park)) +
    geom_line() +
    geom_ribbon(aes(ymin = modci90lo, ymax = modci90up), alpha = 0.5) +
    geom_jitter(data = datMod
                , aes(Year,Stars)
                , alpha=0.5
                , size =0.3
                , width = 0.2
                , height = 0.1
                ) +
    facet_wrap(~Park) +
    labs(y = "Stars - mean credible value"
         , subtitle = "Shading represents 95% credible intervals"
         ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
          , legend.position = "none"
          ) +
    scale_fill_viridis_d(end = 0.9) +
    coord_cartesian(ylim=c(1,5))

```

---

### Origin

Table \@ref(tab:predict3) shows a summary of results for the origin of the reviewer. These results assume a population of reviewers split evenly among the levels of age, gender and year of review. Figure \@ref(fig:modResult3) shows a plot of the results for each park.

```{r predict3}

  # Use the model to predict results over variables of interest
  modPred3 <- datMod %>%
    dplyr::select(Age,Gender,Origin) %>%
    unique() %>%
    dplyr::group_by(Age,Gender,Origin) %>%
    tidyr::expand(time = seq(min(datMod$time),max(datMod$time),1)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = unique(datMod$medYear,na.rm=TRUE)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Year = unique(.$medYear) + time
                  , Stars = value + 1
                  #, Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes3 <- as_tibble(modPred3) %>%
    dplyr::group_by(Year,Origin) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , Mean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.025)
                     , modci90up = quantile(Stars, 0.975)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(modMedian,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_if(is.numeric,round,2)
  
  modRes3Tab <- modRes3 %>%
          dplyr::select(Origin,Year,Mean,`Median and range in 90% credible intervals`=text) %>%
          dplyr::group_by(Origin) %>%
          dplyr::filter(Year == max(Year)) %>%
          dplyr::ungroup() %>%
          dplyr::mutate(Origin = fct_reorder(Origin,Mean,.desc = TRUE)) %>%
          dplyr::arrange(desc(Mean))
  
  kable(modRes3Tab
        , caption = paste0("Summary of model results for the last year with data. ", modRes3Tab %>% dplyr::slice(1:2) %>% pull(Origin) %>% vec_to_sentence(), " have the highest ratings (based on mean credible estimates)")
        )

```

---

```{r modResult3, fig.cap = "Line is mean credible estimate and shading is 95% credible intervals. Dots are original data points (jittered for clarity)"}

  ggplot(data=modRes3,aes(Year,Mean,fill=Origin)) +
    geom_line() +
    geom_ribbon(aes(ymin = modci90lo, ymax = modci90up), alpha = 0.5) +
    geom_jitter(data = datMod
                , aes(Year,Stars)
                , alpha=0.5
                , size =0.3
                , width = 0.2
                , height = 0.1
                ) +
    scale_fill_viridis_d(end=0.9) +
    facet_wrap(~Origin) +
    labs(y = "Mean credible value for Stars"
         , subtitle = "Shading represents 95% credible intervals"
         ) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)
          , legend.position = "none"
          ) +
    coord_cartesian(ylim=c(1,5))

```

# Word analysis

## Overall sentiment

```{r dataWord}

  fixSentiment <- c("wild","desert","falls","unbelievable","unusual","unexpected","miss","challenging","remarkable","steep","cold","dirt","rocky","crashing","downhill","shady","ruins","cave","wedge")

  removeWords <- c("title","review","granite","island","national","park","flinders","ranges","kangaroo","chase","victor","harbor","harbour","morialta","adelaide","mt","mount","lofty","coober","pedy","rocks","arch","gully","ki","wilpena","pound","coffin")
  
  changeWords <- tribble(~word, ~changed
                         , "disappointing","dissapoint"
                         , "disappointed","dissapoint"
                         , "disappointment","dissapoint"
                         , "colours","colour"
                         , "color","colour"
                         , "beauty","beautiful"
                         , "enjoyed","enjoy"
                         , "loved","love"
                         , "sadly","sad"
                         , "difficulty","difficult"
                         , "crowded","crowd"
                         , "limits","limit"
                         , "beaches","beach"
                         , "cycling","cycle"
                         , "cycled","cycle"
                         , "cyclists","cycle"
                         , "riding","cycle"
                         , "rides","cycle"
                         , "mtb","cycle"
                         , "bike","cycle"
                         , "rode","cycle"
                         , "walking","walk"
                         , "walked","walk"
                         , "walks","walk"
                         , "stroll","walk"
                         , "strolling","walk"
                         , "hiking","walk"
                         , "hiked","walk"
                         , "hike", "walk"
                         , "camping","camp"
                         , "camped","camp"
                         , "driving","drive"
                         , "drove","drive"
                         , "penguin","wildlife"
                         , "penguins","wildlife"
                         , "fur","wildlife"
                         , "seal","wildlife"
                         , "seals","wildlife"
                         , "koala","wildlife"
                         , "koalas","wildlife"
                         , "kangaroos","wildlife" # not kangaroos due to KI
                         , "echidna","wildlife"
                         , "platypus","wildlife"
                         , "bird","wildlife"
                         , "birds","wildlife"
                         , "wallabies","wildlife"
                         , "emu","wildlife"
                         , "emus","wildlife"
                         , "animals","wildlife"
                         , "lions","wildlife" # sea lions
                         , "sealions","wildlife"
                         , "landscape","nature"
                         , "view","nature"
                         , "views","nature"
                         , "scenery","nature"
                         , "scenic","nature"
                         , "natural","nature"
                         , "breakaways","nature"
                         , "remarkable","nature"
                         , "admirals","nature"
                         , "waterfall","nature"
                         , "falls","nature"
                         , "waterfalls","nature"
                         , "lighthouse","heritage"
                         , "ruin","heritage"
                         )
  
  datWord <- dat %>%
    tidytext::unnest_tokens(word,Text,drop = FALSE) %>%
    dplyr::left_join(changeWords) %>%
    dplyr::mutate(word = if_else(is.na(changed),word,changed)) %>%
    dplyr::anti_join(tidytext::stop_words) %>%
    dplyr::left_join(tidytext::get_sentiments("bing")) %>%
    dplyr::mutate(sentiment = ifelse(word %in% fixSentiment,NA,sentiment)
                  , sentiment = fct_explicit_na(sentiment,"neutral")
                  ) %>%
    dplyr::filter(!word %in% removeWords)
  
  
```

```{r dataWordOverall}

  datForPlot <- datWord %>%
    dplyr::count(id, reviews, word, sentiment, sort = TRUE) %>%
    dplyr::count(reviews, word, sentiment, sort = TRUE) %>%
    dplyr::group_by(sentiment) %>%
    dplyr::slice(1:10) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(per = 100*n/reviews
                  , word = fct_reorder(word,per)
                  , sentiment = fct_explicit_na(sentiment, na_level = "neutral")
                  , sentiment = fct_relevel(sentiment, "positive", "negative")
                  )

  mostPos <- datForPlot %>% dplyr::filter(sentiment == "positive") %>% dplyr::top_n(1,n) %>% dplyr::pull(word)
  mostNeg <- datForPlot %>% dplyr::filter(sentiment == "negative") %>% dplyr::top_n(1,n) %>% dplyr::pull(word)
  mostNeut <- datForPlot %>% dplyr::filter(sentiment == "neutral") %>% dplyr::top_n(1,n) %>% dplyr::pull(word)

```

Using the tidytext package [@R-tidytext], the text within the character fields `Title` and `Review` were analysed. Some words were replaced with a synonym (Appendix Table \@ref(tab:changeWords)). This includes 'lumping' words such as, say, `echidna` into `wildlife`. 

The following words were reclassified as neutral from negative sentiment as they were overwhelmingly not used in a negative manner: `r vec_to_sentence(sort(fixSentiment),";")`. The following words were removed from the analysis as they refer to park or place names, and occur frequently, but do not add much to the analysis: `r vec_to_sentence(sort(removeWords),";")`.

Figure \@ref(fig:wordOverall) shows the ten most common positive, negative and neutral words given in the combined `Title` and `Review` fields.

The most frequent word with positive sentiment was ``r mostPos``. A random sample of contexts in which ``r mostPos`` occured:

* `r paste0(datWord %>% dplyr::select(Title) %>% unique() %>% dplyr::filter(grepl(mostPos,Title)) %>% dplyr::sample_n(5) %>% dplyr::pull(Title),collapse="\n* ")`

The most frequent word with neutral sentiment was ``r mostNeut``. A random sample of contexts in which ``r mostNeut`` occured:

* `r paste0(datWord %>% dplyr::select(Title) %>% unique() %>% dplyr::filter(grepl(mostNeut,Title)) %>% dplyr::sample_n(5) %>% dplyr::pull(Title),collapse="\n* ")`

The most frequent word with negative sentiments was ``r mostNeg``. A random sample of contexts in which ``r mostNeg`` occurred:

* `r paste0(datWord %>% dplyr::select(Title) %>% unique() %>% dplyr::filter(grepl(mostNeg,Title)) %>% dplyr::sample_n(5) %>% dplyr::pull(Title),collapse="\n* ")`

---

```{r wordOverall, fig.cap = "Titles had words with positive sentiment much more frequently than words with negative sentiment"}
  
  ggplot(datForPlot, aes(word,per,fill=sentiment)) +
    geom_col() +
    coord_flip() +
    facet_grid(sentiment~., scales = "free_y", space = "free_y") +
    scale_fill_viridis_d(end = 0.8) +
    labs(y = "Percentage of titles using word (or synonym)")

```

---

## By park sentiment

```{r dataWordPark}

  datForPlot <- datWord %>%
    dplyr::group_by(Park) %>%
    dplyr::mutate(reviews = n_distinct(id)) %>%
    dplyr::ungroup() %>%
    dplyr::count(id, word, Park, reviews, sentiment, sort = TRUE) %>%
    dplyr::count(word, Park, reviews, sentiment, sort = TRUE) %>%
    dplyr::filter(reviews > quantile(unique(reviews), probs = 0.5)) %>%
    dplyr::group_by(Park,sentiment) %>%
    dplyr::slice(1:5) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(Park,n) %>%
    dplyr::mutate(order = row_number()
                  , per = 100*n/reviews
                  , sentiment = fct_explicit_na(sentiment, na_level = "neutral")
                  , sentiment = fct_relevel(sentiment, "positive", "negative")
                  , label = paste0(Park,". reviews = ",reviews)
                  )

  mostFreqWord <- datForPlot %>%
    dplyr::count(sentiment,word,sort=TRUE) %>%
    dplyr::group_by(sentiment) %>%
    dplyr::slice(1) %>%
    dplyr::ungroup()
  
  mostFreqPos <- mostFreqWord %>% dplyr::filter(sentiment == "positive") %>% dplyr::pull(word)
  mostFreqNeg <- mostFreqWord %>% dplyr::filter(sentiment == "negative") %>% dplyr::pull(word)
  mostFreqNeut <- mostFreqWord %>% dplyr::filter(sentiment == "neutral") %>% dplyr::pull(word)

```

Figure \@ref(fig:wordPark) shows, by park, the five most common positive, negative and neutral words given in the combined `Title` and `Review` fields.

Most parks had ``r mostFreqPos`` in their positive words, for example:

* `r paste0(datWord %>% dplyr::select(Title) %>% unique() %>% dplyr::filter(grepl(mostFreqPos,Title)) %>% dplyr::sample_n(5) %>% dplyr::pull(Title),collapse="\n* ")`

Most parks had ``r mostFreqNeg`` in their negative words, for example:

* `r paste0(datWord %>% dplyr::select(Title) %>% unique() %>% dplyr::filter(grepl(paste0("\\b",mostFreqNeg,"\\b"),Title)) %>% dplyr::sample_n(5) %>% dplyr::pull(Title),collapse="\n* ")`

---

```{r wordPark, fig.height = 12, fig.cap = "Top ten words in each sentiment class (positive, negative and neutral) for the parks with the most reviews"}

  ggplot(datForPlot, aes(order,per,fill=sentiment)) +
    geom_bar(stat = "identity") +
    facet_wrap(~Park, ncol = 3, scales = "free_y"
               #, labeller = labeller(label = label_wrap_gen(15))
               ) +
    scale_x_continuous(breaks = datForPlot$order
                       , labels = datForPlot$word
                       , expand = c(0,0)
                       ) +
    scale_fill_viridis_d(end = 0.8) +
    coord_flip() +
    labs(y = "Percentage of titles using word (or synonym)") +
    theme(legend.position = "top")

```

---

# Activities

```{r datactivity}

  searches <- read_csv("data/searches.csv",quote='"')

  activities <- searches %>%
    dplyr::filter(Type == "activity") %>%
    dplyr::group_by(Use) %>%
    tidyr::nest() %>%
    dplyr::mutate(reviews = map_dbl(data,function(x) sum(str_detect(tolower(dat$Text),tolower(paste(x$Find,collapse="|")))))
                  , per = round(100*reviews/nrow(dat),2)
                  , Use = fct_reorder(Use,per)
                  , text = paste0(Use,": ",round(per,1),"%")
                  )
  
  activitiesPark <- dat %>%
    dplyr::add_count(Park) %>%
    dplyr::group_by(Park,n) %>%
    tidyr::nest() %>%
    dplyr::mutate(activities = map(data
                                   ,function(x) searches %>%
                                     dplyr::filter(Type == "activity") %>%
                                     dplyr::group_by(Use) %>%
                                     tidyr::nest() %>%
                                     dplyr::mutate(reviews = map_dbl(data,function(y) sum(str_detect(tolower(x$Text),tolower(paste(y$Find,collapse="|"))))))
                                   )
                  ) %>%
    tidyr::unnest(activities) %>%
    dplyr::filter(reviews > 0) %>%
    dplyr::mutate(per = 100*reviews/n)

```

These activities were searched for in the combined `Title` and `Review` fields: `r searches %>% dplyr::filter(Type == "activity") %>% dplyr::count(Use) %>% dplyr::pull(Use) %>% unique() %>% vec_to_sentence(";")`. Appendix Table \@ref(tab:activities) shows which words were treated as synonyms for each activity.

## Overall activities

Figure \@ref(fig:activityOverall) shows how frequently each of those activities were mentioned overall.

---

```{r activityOverall, fig.cap = paste0(activities %>% dplyr::top_n(3,per) %>% dplyr::pull(Use) %>% vec_to_sentence()," are the most popular activities mentioned in reviews")}

  activities %>%
    ggplot(aes(Use,per)) +
      geom_bar(stat = "identity") +
      coord_flip()

```

---

## Activities by park

Figure \@ref(fig:activityByActivity) shows, by activity, how frequently each of those activities were mentioned for the most visited parks. Figure \@ref(fig:activityByPark) shows, by park, how frequently each of those activities were mentioned for the most visited parks.

See appendix Table \@ref(tab:activityAll) for the full list of parks and activities.

```{r activityByActivity, fig.height = 14, fig.cap = "Top 10 activities - frequency within park"}

  datForPlot <- activitiesPark %>%
    dplyr::inner_join(activities %>% dplyr::top_n(10,reviews) %>% dplyr::select(Use)) %>%
    dplyr::group_by(Use) %>%
    dplyr::top_n(10,reviews) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(Use,per) %>%
    dplyr::mutate(order = row_number()
                  , Use = fct_reorder(Use,desc(per))
                  )

  ggplot(datForPlot, aes(order,per)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = datForPlot$order
                       , labels = datForPlot$Park
                       , expand = c(0,0)
                       ) +
    coord_flip() +
    facet_wrap(~Use,scales = "free",ncol=2) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    labs(x = "Park", y = "Percentage of park reviews")

```

---

```{r activityByPark, fig.height = 12, fig.cap = "Top 10 parks - frequency of activities within park"}

  datForPlot <- activitiesPark %>%
    dplyr::inner_join(activitiesPark %>% dplyr::select(Park,n) %>% unique() %>% dplyr::top_n(10,n)) %>%
    dplyr::arrange(Park,per) %>%
    dplyr::mutate(order = row_number()
                  , Park = fct_reorder(Park,desc(per))
                  )

  ggplot(datForPlot, aes(order,per)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = datForPlot$order
                       , labels = datForPlot$Use
                       , expand = c(0,0)
                       ) +
    coord_flip() +
    facet_wrap(~Park,scales = "free",ncol=2) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

---

# Facilities

```{r dataFacility}
  
  datSentence <- dat %>%
    tidytext::unnest_tokens(sentence,Text,token="sentences",drop=FALSE) %>%
    dplyr::mutate(sentenceID = row_number()) %>%
    tidytext::unnest_tokens(word,sentence,drop=FALSE) %>%
    dplyr::left_join(tidytext::get_sentiments("afinn")) %>%
    dplyr::group_by(id,sentenceID,sentence) %>%
    dplyr::summarise(sent = sum(score,na.rm=TRUE)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(sentClass = if_else(sent > 0,"positive",if_else(sent < 0,"negative","neutral"))
                  , sentClass = fct_relevel(sentClass,"positive","neutral")
                  )

  facilities <- searches %>%
    dplyr::filter(Type == "facility") %>%
    dplyr::group_by(Use) %>%
    tidyr::nest() %>%
    dplyr::mutate(facility = map(data
                                 , function(x) tibble(facility = str_detect(tolower(datSentence$sentence),tolower(paste(x$Find,collapse="|")))) %>%
                                   dplyr::bind_cols(datSentence)
                                 )
                  ) %>%
    tidyr::unnest(facility)
  
  facilitiesOverall <- facilities %>%
    dplyr::filter(facility) %>%
    dplyr::group_by(Use,sentClass) %>%
    dplyr::summarise(n = n()
                     , sent = mean(sent)
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(per = 100*n/nrow(dat))
    
  
  facilitiesPark <- facilities %>%
    dplyr::left_join(dat %>% add_count(Park) %>% select(id,Park,n)) %>%
    dplyr::filter(facility) %>%
    dplyr::group_by(Park,n,Use,sentClass) %>%
    dplyr::summarise(sentences = n()
                     , reviews = n_distinct(id)
                     , sent = mean(sent)
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(per = 100*reviews/n)

```

These facilities were searched for in the combined `Title` and `Review` fields: `r searches %>% dplyr::filter(Type == "facility") %>% dplyr::count(Use) %>% dplyr::pull(Use) %>% unique() %>% vec_to_sentence(";")`. Appendix Table \@ref(tab:facilities) shows which words were treated as synonyms for each type of facility.

The sentiment of the sentence in which facilities were mentioned was determined using the AFINN lexicon [@AFINN], provided by the tidytext package [@R-tidytext].

## Overall facilities

Figure \@ref(fig:facilityOverall) shows how frequently each facility was mentioned, including the sentiment of the sentence in which the facility was mentioned.

---

```{r facilityOverall, fig.cap = "Facilities most frequently mentioned in reviews and the sentiment of the sentence in which they occur"}

  facilitiesOverall %>%
    dplyr::mutate(Use = fct_reorder(Use,per)) %>%
    ggplot(aes(Use,per,fill=fct_rev(sentClass))) +
      geom_bar(stat = "identity", position = "dodge") +
      coord_flip() +
      labs(x = "Facilities", y = "Percentage of reviews"
           , fill = "Sentiment of sentence"
           ) +
      scale_fill_viridis_d(guide = guide_legend(reverse=TRUE))

```

---

## Facilities by park

Figure \@ref(fig:facilityByPark) shows, by park, how frequently each facility was mentioned for the most visited parks, including the sentiment of the sentence in which the facility was mentioned.

See appendix Table \@ref(tab:facilityAll) for the full list of parks and facilities.

---

```{r facilityByPark, fig.height = 12, fig.cap = "Top 10 parks - frequency of facilities within park"}

  datForPlot <- facilitiesPark %>%
    dplyr::inner_join(facilitiesPark %>% dplyr::select(Park,n) %>% unique() %>% dplyr::top_n(10,n)) %>%
    dplyr::arrange(Park,per) %>%
    dplyr::mutate(order = row_number()
                  , Use = fct_reorder(Use,per)
                  )

  ggplot(datForPlot, aes(Use,per,fill=fct_rev(sentClass))) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_grid(Park~sentClass
               , labeller = labeller(Park = label_wrap_gen(15))
               ) +
    theme(strip.text.y = element_text(angle = 0)) +
    labs(y = "Percentage of reviews"
         , fill = "Review sentiment"
         , x = "Park"
         ) +
    scale_fill_viridis_d(guide = guide_legend(reverse=TRUE))

```

---

# Discussion

## Questions

It is now possible to answer the questions posed at the start with respect to the TripAdvisor data.

### What is the effect of age and gender on the rating given?

There was very little effect of age and gender on stars. 18-24 year old males had the lowest mean credible estimate for stars but this was still a relatively healthy `r modRes %>% dplyr::filter(Gender == "Male", Age =="18-24") %>% dplyr::filter(Year == max(Year)) %>% dplyr::pull(Mean)` stars.

### What is the effect of the park visited on the rating given?

There was little effect of park on the rating given. In the last year there was only `r modRes2 %>% dplyr::filter(Year == max(Year)) %>% dplyr::mutate(diff=Mean-min(Mean)) %>% pull(diff) %>% max()` stars difference between the maximum and minimum mean credible estimate for stars given to parks in the dataset. This is only `r 100*(modRes2 %>% dplyr::filter(Year == max(Year)) %>% dplyr::mutate(diff=Mean-min(Mean)) %>% pull(diff) %>% max())/5`% of the possible range of 1 to 5.

### What is the effect of the origin of a reviewer on the rating given?

There was very little effect of the origin of a reviewer on the rating given. In the last year, there was only `r modRes3 %>% dplyr::filter(Year == max(Year)) %>% dplyr::mutate(diff=Mean-min(Mean)) %>% pull(diff) %>% max()` stars or `r 100*(modRes3 %>% dplyr::filter(Year == max(Year)) %>% dplyr::mutate(diff=Mean-min(Mean)) %>% pull(diff) %>% max())/5`% of the possible difference.

### Summary

The TripAdvisor data has little resolution in stars given for the attributes available for analysis. Most reviewers give South Australian DEW managed parks very good reviews - roughly `r dat %>% pull(Stars) %>% mean() %>% round(1)` stars on average.

## Words used in reviews

As for the stars analysis, the word analysis showed overwhelmingly positive words were used to describe both overall parks (e.g. Figure \@ref(fig:wordOverall) and specific parks Figures \@ref(fig:wordPark)).

Reviewers most frequently mentioned `r datWord %>% dplyr::filter(sentiment == "neutral") %>% dplyr::count(word) %>% dplyr::top_n(3,n) %>% dplyr::pull(word) %>% vec_to_sentence(";")` in their reviews along with positive words such as `r datWord %>% dplyr::filter(sentiment == "positive") %>% dplyr::count(word) %>% dplyr::top_n(5,n) %>% dplyr::pull(word) %>% vec_to_sentence(";")`.

## Activities

The most popular activities in parks (and % of reviews in which the activity was mentioned) were:
 
 * `r paste0(activities %>% dplyr::top_n(3,per) %>% dplyr::pull(text),collapse = "\n* ")`
 
## Facilities

The faciltities most mentioned in reviews (and % of reviews in which the activity was mentioned) were:
 
 * `r paste0(facilitiesOverall %>% dplyr::group_by(Use) %>% dplyr::summarise(per=100*sum(n)/nrow(dat)) %>% dplyr::mutate(text = paste0(Use,": ",round(per,1),"%")) %>% dplyr::top_n(3,per) %>% dplyr::pull(text),collapse = "\n* ")`

# Appendix

## Changed words

```{r changeWords}

  kable(changeWords
        , caption = "Words that were changed to a synonym before further analysis"
        )

```

## Activities

```{r activities}

  kable(searches %>% dplyr::filter(Type == "activity") %>% dplyr::select(-Notes)
        , caption = "Activities and associated synonyms, including regular expression syntax used in searches. e.g. '.?' means match a space zero or one time; (?!...) is a negative lookaround (e.g. used for find 'dog' without 'fence')"
        )

```

---

```{r activityAll,results="asis"}

  cat("<table>",paste0("<caption>","(#tab:activityAll)","Full list of activities and parks","</caption>"),"</table>", sep = "\n")
  
  datatable(activitiesPark %>%
              dplyr::mutate_if(is.numeric,round,1) %>%
              dplyr::select(Activity = Use
                            , Park
                            , Reviews = n
                            , `Mention activity` = reviews
                            , Percentage = per
                            )
            , filter = "top"
            ) 

```

---

## Facilities

```{r facilities}

  kable(searches %>% dplyr::filter(Type == "facility") %>% dplyr::select(-Notes)
        , caption = "Facilities and associated synonyms, including regular expression syntax used in searches. e.g. '.?' means match a space zero or one time"
        )

```

---

```{r facilityAll,results="asis"}

  cat("<table>",paste0("<caption>","(#tab:facilityAll)","Full list of facilities and parks","</caption>"),"</table>", sep = "\n")
  
  datatable(facilitiesPark %>%
              dplyr::mutate_if(is.numeric,round,1) %>%
              dplyr::select(Facility = Use
                            , Park
                            , Reviews = n
                            , Sentiment = sentClass
                            , `Mention facility` = reviews
                            , Percentage = per
                            )
            , filter = "top"
            ) 

```

---

## R packages used

```{r packages, fig.cap = "R [@R-base] packages used to produce this report"}

  kable(tibble(Package = read_lines("rPackages.bib")) %>%
    dplyr::filter(grepl("@",Package)
                  , !grepl("CiteR",Package)
                  ) %>%
    dplyr::mutate(Package = gsub("@Manual\\{|,|R-","",Package)) %>%
    dplyr::arrange() %>%
    dplyr::mutate(Citation = paste0("@R-",Package))
   , caption = "R [@R-base] packages used in the production of this report" 
   )

```

# References
