---
title: "Analysis of Trip Advisor data relating to South Australian parks"
author:
- Department for Environment and Water
date: "`r format(Sys.time(), '%A, %d %B, %Y')`"
output:
  bookdown::gitbook:
    split_by: chapter
    toc_depth: 3
    css: style.css
    keep_md: no
csl:                          "common/BibStyle.csl"
bibliography:                 ["common/refs.bib","common/packageCitations.bib","common/RC.bib"]
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, warning = FALSE, echo = FALSE, message = FALSE}

  useCores <- round(parallel::detectCores()*3/4,0)

  packages <- c("knitr"
                ,"bookdown"
                ,"tidyverse"
                ,"readxl"
                ,"fs"
                ,"lubridate"
                ,"rstan"
                ,"rstanarm"
                ,"ggridges"
                )
  
  purrr::walk(packages,library,character.only=TRUE)
  
  write_bib(packages,file="rPackages.bib",tweak=TRUE)
  
  source("common/functions.R")
  
  # Set default chunk options (can adjust individual chunks differently if required)
  knitr::opts_chunk$set(warning = FALSE
                        , message = FALSE
                        , echo = FALSE
                        )
  
  options(knitr.kable.NA = "")
  
  # Set mapping defaults
  tmap_options(basemaps = c("OpenStreetMap.Mapnik"
                            , "Esri.WorldImagery"
                            )
               )
  
  # reset ggplot default theme (rstanarm changes it for some reason)
  theme_set(theme_grey())
  
```
  
```{r data}

  dat <- dir_info("data") %>%
    dplyr::filter(grepl("xlsx$",path)) %>%
    dplyr::mutate(data = map(path, read_excel)) %>%
    dplyr::select(data) %>%
    tidyr::unnest() %>%
    dplyr::mutate(User = gsub(" R.$","",User)
                  , Year = year(Date)
                  , Month = format(Date,"%B")
                  , month = as.numeric(format(Date,"%m"))
                  , Month = fct_reorder(Month,month)
                  , Yearmon = as_date(paste0("01/",Month,"/",Year),tz=Sys.timezone(),format="%d/%B/%Y")
                  , Age = gsub("18-34","18-24",Age)
                  ) %>%
    dplyr::mutate_if(is.character,funs(gsub("^Null$|^Not given$",NA,.)))

```

# Data exploration

## Summary

Between `r format(min(dat$Date),"%d/%B/%Y")` and `r format(max(dat$Date),"%d/%B/%Y")` there were `r nrow(dat)` reviews on [Trip Advisor](https://www.tripadvisor.com.au/) that could be associated with South Australian parks.

## Missing data

```{r dataMissing}

  datMiss <- dat %>%
    summarise_all(funs(sum(is.na(.)))) %>%
    t() %>%
    data.frame() %>%
    rownames_to_column() %>%
    dplyr::rename(column = 1, NAs = 2) %>%
    dplyr::mutate(per = 100*NAs/nrow(dat)
                  , column = fct_inorder(column)
                  )

```

Some of the key data fields were left blank in many reviews. For example, `r sum(is.na(dat$Gender))` (`r round(100*sum(is.na(dat$Gender))/nrow(dat),0)`%) reviews did not provide their gender and `r sum(is.na(dat$Age))` (`r round(100*sum(is.na(dat$Age))/nrow(dat),0)`%) didn't provide their age. Figure \@ref(fig:plotMissing) shows the percentage of reviews that did not provide information against each field.

```{r plotMissing, fig.cap = "A large proportion of reviews did not answer some questions, particularly Gender and Age"}

  ggplot(datMiss, aes(column,per)) +
    geom_col() +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x = "Column"
         , y = "Percentage of null (NA) cells in each column"
         )

```

## Count of reviews

```{r dataCount}
  
  datCount <- dat %>%
    dplyr::select(-Title,-Review,-Yearmon,-Date) %>%
    tidyr::gather(variable,value,1:ncol(.)) %>%
    dplyr::count(variable,value) 

```

There are several variables in the data with relatively few levels: `r vec_to_sentence(unique(pull(datCount,variable)),";")`. Figure \@ref(fig:plotDiscrete) shows the most frequently occuring values in each of those variables.

```{r plotDiscrete, fig.cap = "Most frequent values in each of the variables. Most reviews are from Adelaide based 50-64 year olds called Charmaine who visit Flinders Chase in January"}
  
  ggplot(datCount %>%
           dplyr::filter(n > 4)%>%
           dplyr::group_by(variable) %>%
           dplyr::top_n(12) %>%
           dplyr::ungroup() %>%
           dplyr::mutate(value = fct_reorder(value,n))
         ) +
    geom_col(aes(value,n)) +
    facet_wrap(~variable, scales = "free",ncol=2) +
    coord_flip() +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x = "Value of variable"
         , y = "Count of value"
         )

```


# Analysis

```{r model}

  # variables to model
  varMod <- c("Y"
              , "time"
              , "Month"
              , "Age"
              , "Gender"
              , "Park"
              , "Country"
              )
  
  datMod <- dat %>%
    dplyr::filter(Age != "13-17"
                  , Year >= 2011
                  ) %>%
    dplyr::mutate(Y = Stars -1
                  , medYear = median(Year)
                  , time = Year - medYear
                  ) %>%
    dplyr::select(varMod) %>%
    na.omit()
    
  if(file_exists(paste0("out/Stars_mod.rds"))) {
    
    mod <- read_rds(paste0("out/Stars_mod.rds"))
    
  } else {
    
    mod <-
      
      stan_glm(
        as.formula(paste("cbind(Y,4-Y) ~ Gender+Age+time+Month")) #binomial
        , data = datMod
        , family = binomial
        , chains = 5
        , iter = 500
        , cores = useCores
      )
    
    saveRDS(mod,paste0("out/Stars_mod.rds"))
    
  }

```

```{r mixing, fig.cap = "All chains converged around the same values for each of the model paramaters (first 10 shown here)"}

  stan_trace(mod)

```

---

```{r rhat, fig.cap = "Rhat values show no reason for concern"}

  plot(mod, "rhat_hist")

```

---

```{r fit, fig.cap = "The model runs under estimate four stars and over estimate three stars relative to the data"}

  # Model fit
  pp_check(mod)

```

---

```{r prop0, fig.cap = "The model runs tend to over estimate zero (1 star)"}

  prop_zero <- function(x) mean(x == 0)

  pp_check(mod
           , plotfun = "stat"
           , stat = "prop_zero"
           )

```

---

```{r meanVsSd, fig.cap = "Collectively the model runs do a reasonable job estimating the data"}

  pp_check(mod, plotfun = "stat_2d", stat = c("mean", "sd"))

```

---

```{r predict}

  # Use the model to predict results over variables of interest
  modPred <- datMod %>%
    dplyr::select(time,Month,Age,Gender) %>%
    unique() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = median(dat$Year)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Year = unique(.$medYear) + time
                  , Stars = value + 1
                  , Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes <- as_tibble(modPred) %>%
    dplyr::group_by(Year,Month,Age,Gender) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , modMean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.05)
                     , modci90up = quantile(Stars, 0.95)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(ci,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_if(is.numeric,round,2)
  
    


```

```{r park}

  ggplot(modPred,aes(Stars,y=..prop..,fill=Month)) +
    geom_bar(position = "dodge") +
    scale_fill_viridis_d() +
    coord_flip()

```


