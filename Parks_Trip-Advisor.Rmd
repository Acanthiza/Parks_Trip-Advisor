---
title: "Analysis of Trip Advisor data relating to South Australian parks"
author:
- Department for Environment and Water
date: "`r format(Sys.time(), '%A, %d %B, %Y')`"
output:
  bookdown::gitbook:
    split_by: chapter
    toc_depth: 3
    css: style.css
    keep_md: no
csl:                          "common/BibStyle.csl"
bibliography:                 ["common/refs.bib","common/packageCitations.bib","common/RC.bib"]
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, warning = FALSE, echo = FALSE, message = FALSE}

  useCores <- round(parallel::detectCores()*3/4,0)

  packages <- c("knitr"
                ,"bookdown"
                ,"tidyverse"
                ,"readxl"
                ,"fs"
                ,"lubridate"
                ,"rstan"
                ,"rstanarm"
                ,"ggridges"
                ,"tmap"
                )
  
  purrr::walk(packages,library,character.only=TRUE)
  
  write_bib(packages,file="rPackages.bib",tweak=TRUE)
  
  source("common/functions.R")
  
  # Set default chunk options (can adjust individual chunks differently if required)
  knitr::opts_chunk$set(warning = FALSE
                        , message = FALSE
                        , echo = FALSE
                        )
  
  options(knitr.kable.NA = "")
  
  # Set mapping defaults
  tmap_options(basemaps = c("OpenStreetMap.Mapnik"
                            , "Esri.WorldImagery"
                            )
               )
  
  # reset ggplot default theme (rstanarm changes it for some reason)
  theme_set(theme_grey())
  
```
  
```{r data}

  dat <- dir_info("data") %>%
    dplyr::filter(grepl("xlsx$",path)) %>%
    dplyr::mutate(data = map(path, read_excel)) %>%
    dplyr::select(data) %>%
    tidyr::unnest() %>%
    dplyr::mutate(User = gsub(" R.$","",User)
                  , Year = year(Date)
                  , Month = format(Date,"%B")
                  , month = as.numeric(format(Date,"%m"))
                  , Month = fct_reorder(Month,month)
                  , Yearmon = as_date(paste0("01/",Month,"/",Year),tz=Sys.timezone(),format="%d/%B/%Y")
                  , Age = gsub("18-34","18-24",Age)
                  ) %>%
    dplyr::mutate_if(is.character,list(~gsub("^Null$|^Not given$",NA,.))) %>%
    dplyr::select(-month) %>%
    dplyr::filter(!grepl("13",Age))

```

# Data exploration

## Summary

Between `r format(min(dat$Date),"%d/%B/%Y")` and `r format(max(dat$Date),"%d/%B/%Y")` there were `r nrow(dat)` reviews on [Trip Advisor](https://www.tripadvisor.com.au/) that could be associated with South Australian parks.

## Missing data

```{r dataMissing}

  datMiss <- dat %>%
    summarise_all(list(~sum(is.na(.)))) %>%
    t() %>%
    data.frame() %>%
    rownames_to_column() %>%
    dplyr::rename(column = 1, NAs = 2) %>%
    dplyr::mutate(per = 100*NAs/nrow(dat)
                  , column = fct_inorder(column)
                  )

```

Some of the key data fields were left blank in many reviews. For example, `r sum(is.na(dat$Gender))` (`r round(100*sum(is.na(dat$Gender))/nrow(dat),0)`%) reviews did not provide their gender and `r sum(is.na(dat$Age))` (`r round(100*sum(is.na(dat$Age))/nrow(dat),0)`%) didn't provide their age. Figure \@ref(fig:plotMissing) shows the percentage of reviews that did not provide information against each field.

```{r plotMissing, fig.cap = "A large proportion of reviews did not answer some questions, particularly Gender and Age"}

  ggplot(datMiss, aes(column,per)) +
    geom_col() +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x = "Column"
         , y = "Percentage of null (NA) cells in each column"
         )

```

## Count of reviews

```{r dataCount}
  
  datCount <- dat %>%
    dplyr::select(-Title,-Review,-Yearmon,-Date) %>%
    tidyr::gather(variable,value,1:ncol(.)) %>%
    dplyr::count(variable,value) 

```

There are several variables in the data with relatively few levels: `r vec_to_sentence(unique(pull(datCount,variable)),";")`. Figure \@ref(fig:plotDiscrete) shows the most frequently occuring values in each of those variables.

```{r plotDiscrete, fig.height = 10, fig.cap = "Most frequent values in each of the variables. Most reviews are from Adelaide based 50-64 year olds called Charmaine who visit Flinders Chase in January"}
  
  ggplot(datCount %>%
           dplyr::filter(n > 4)%>%
           dplyr::group_by(variable) %>%
           dplyr::top_n(12) %>%
           dplyr::ungroup() %>%
           dplyr::mutate(value = fct_reorder(value,n))
         ) +
    geom_col(aes(value,n)) +
    facet_wrap(~variable, scales = "free",ncol=2) +
    coord_flip() +
    theme(axis.text.x = element_text(angle = 90)) +
    labs(x = "Value of variable"
         , y = "Count of value"
         )

```


# Overall analysis

```{r model}

  modFile <- "out/model_stars-by-age=gender-year.rds"

  # variables to model
  varMod <- c("Y"
              , "time"
              , "Month"
              , "Age"
              , "Gender"
              , "Park"
              , "State"
              )
  
  datMod <- dat %>%
    dplyr::filter(Year > 2011, Year < 2019) %>%
    dplyr::mutate(Y = Stars -1
                  , medYear = median(Year)
                  , time = Year - medYear
                  , State = fct_lump_min(State, min = 10)
                  , Park = fct_lump_min(Park, min = 10)
                  ) %>%
    dplyr::select(varMod) %>%
    na.omit()
    
  if(file_exists(modFile)) {
    
    mod <- read_rds(modFile)
    
  } else {
    
    mod <-
      
      stan_glmer(
        as.formula(paste("cbind(Y,4-Y) ~ Gender*Age*time + (1|Month) + (1|Park) + (1|State)")) #binomial
        , data = datMod
        , family = binomial
        #, chains = 5
        #, iter = 500
        , cores = useCores
      )
    
    saveRDS(mod,modFile)
    
  }

```

## Model

Trend through time (year) in stars given by age and gender of reviewers (and the interaction of age, gender and time) was analysed using a Bayesian binomial generalised linear mixed model. The analysis was run using the rstanarm package [@RN4481] in R [@R-base]. Month (of review), Park (visited by reviewer) and State (of origin of reviewer) were treated as random effects in the analysis. Each reviewer was then assumed to provide an independent data point for the analysis. A time field was generated as $time = min(Year) + (max(Year) - min(Year))/2$. The model specification was:

``r format(formula(mod))`` where `Y` is Stars-1.

## Model diagnostics

Figure \@ref(fig:mixing) shows that each of the chains used to estimate model parameters converged around similar values for each parameter.

```{r mixing, fig.cap = "All chains converged around the same values for each of the model paramaters (first 10 shown here)"}

  stan_trace(mod)

```

---

Figure \@ref(fig:rhat) provides further support for convergence of the chains as no values are markedly different to 1.0.

```{r rhat, fig.cap = "Rhat values show no reason for concern"}

  plot(mod, "rhat_hist")

```

---

Figure \@ref(fig:fit) shows how (a sample of) the model runs (in light blue) compare with the original data (shown in dark blue).

```{r fit, fig.cap = "The model runs under estimate four stars and over estimate three stars relative to the data"}

  # Model fit
  pp_check(mod)

```

---

Figure \@ref(fig:meanVsSd) shows how the mean and standard deviation of the model runs (in light blue) compare with that of the original data (in dark blue).

```{r meanVsSd, fig.cap = "Collectively the model runs do a reasonable job estimating the data"}

  pp_check(mod, plotfun = "stat_2d", stat = c("mean", "sd"))

```

---

## Model predictions

In order to better understand how the data and resulting model are able to inform management, a number (4000) of simulations were made based on the model results (strictly, draws were made from the posterior predictive distribution). Each simulation generated a prediction based on a single draw of the model parameters from their predicted distributions. Table \@ref(tab:predict) shows a summary of these results.

```{r predict}

  # Use the model to predict results over variables of interest
  modPred <- datMod %>%
    dplyr::select(time,Age,Gender) %>%
    unique() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = median(dat$Year)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Year = unique(.$medYear) + time
                  , Stars = value + 1
                  #, Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes <- as_tibble(modPred) %>%
    dplyr::group_by(Year,Age,Gender) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , modMean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.025)
                     , modci90up = quantile(Stars, 0.975)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(modMedian,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_if(is.numeric,round,2)
  
  kable(modRes %>%
          dplyr::select(Year,Age,Gender,modMean,`Median and range in 90% credible intervals`=text)
        , caption = "Summary of model results"
        )

```

---

Figure \@ref(fig:modResult) shows a plot of the model results. Overwhelmingly, reviewers give 5 stars, irrespective of age or gender.

```{r modResult, fig.cap = "Model results. Most reviewers give 5 stars irrespective of age or gender. The lower 95% credible intervals go to three stars in almost every case - i.e. more than 95% of responses are three stars or more. 18-24 year old males in 2017 are the main exception - they have a mean of 4 stars with 95% credible intervals stretching from 1-5"}

  ggplot(data=modRes,aes(Year,modMedian,group=Age)) +
    geom_line() +
    geom_ribbon(aes(ymin = modci90lo, ymax = modci90up, fill = Age), alpha = 0.6) +
    scale_colour_viridis_d() +
    scale_fill_viridis_d() +
    facet_grid(Age~Gender
               #, scales="free"
               ) +
    labs(y = "Median credible value for Stars"
         , subtitle = "Shading represents 95% credible intervals"
         )

```

# Park

# Park analysis

```{r model2}

  modFile <- "out/model_stars-by-park.rds"

  # variables to model
  varMod <- c("Y"
              , "Age"
              , "Gender"
              , "Park"
              , "State"
              )
  
  datMod <- dat %>%
    dplyr::filter(Year > 2011, Year < 2019) %>%
    dplyr::mutate(Y = Stars -1
                  , State = fct_lump_min(State, min = 100)
                  , Park = fct_lump_min(Park, min = 100)
                  ) %>%
    dplyr::select(varMod) %>%
    na.omit()
    
  if(file_exists(modFile)) {
    
    mod <- read_rds(modFile)
    
  } else {
    
    mod <-
      
      stan_glmer(
        as.formula(paste("cbind(Y,4-Y) ~ Gender*Age*Park + (1|State)")) #binomial
        , data = datMod
        , family = binomial
        #, chains = 5
        #, iter = 500
        , cores = useCores
      )
    
    saveRDS(mod,modFile)
    
  }

```

## Model

Stars given to a park were analysed by age, gender and origin of reviewer using a Bayesian binomial generalised linear mixed model. The analysis was run using the rstanarm package [@RN4481] in R [@R-base]. The model specification was:

``r format(formula(mod))`` where `Y` is Stars-1.

## Model diagnostics

Figure \@ref(fig:mixing2) shows that each of the chains used to estimate model parameters converged around similar values for each parameter.

```{r mixing2, fig.cap = "All chains converged around the same values for each of the model paramaters (first 10 shown here)"}

  stan_trace(mod)

```

---

Figure \@ref(fig:rhat2) provides further support for convergence of the chains as no values are markedly different to 1.0.

```{r rhat2, fig.cap = "Rhat values show no reason for concern"}

  plot(mod, "rhat_hist")

```

---

Figure \@ref(fig:fit2) shows how (a sample of) the model runs (in light blue) compare with the original data (shown in dark blue).

```{r fit2, fig.cap = "The model runs under estimate four stars and over estimate three stars relative to the data"}

  # Model fit
  pp_check(mod)

```

---

Figure \@ref(fig:meanVsSd2) shows how the mean and standard deviation of the model runs (in light blue) compare with that of the original data (in dark blue).

```{r meanVsSd2, fig.cap = "Collectively the model runs do a reasonable job estimating the data"}

  pp_check(mod, plotfun = "stat_2d", stat = c("mean", "sd"))

```

---

## Model predictions

In order to better understand how the data and resulting model are able to inform management, a number (4000) of simulations were made based on the model results (strictly, draws were made from the posterior predictive distribution). Each simulation generated a prediction based on a single draw of the model parameters from their predicted distributions. Table \@ref(tab:predict) shows a summary of these results.

```{r predict}

  # Use the model to predict results over variables of interest
  modPred <- datMod %>%
    dplyr::select(Age,Gender,Park) %>%
    unique() %>%
    dplyr::mutate(col = row.names(.)
                  , Y = 4
                  , medYear = median(dat$Year)
                  ) %>%
    dplyr::left_join(as_tibble(posterior_predict(mod
                                                 , newdata = .
                                                 , re.form = NA
                                                 )
                               ) %>%
                       tibble::rownames_to_column(var = "row") %>%
                       tidyr::gather(col,value,2:ncol(.))
                     ) %>%
    (function(x) dplyr::bind_cols(x %>% dplyr::select(-value),value = as.numeric(x$value))) %>%
    dplyr::mutate(Stars = value + 1
                  #, Month = as.factor(Month, levels = levels(datMod$Month))
                  )

  # summarise the results
  modRes <- as_tibble(modPred) %>%
    dplyr::group_by(Age,Gender,Park) %>%
    dplyr::summarise(n = n()
                     , nCheck = nrow(as_tibble(mod))
                     , modMedian = quantile(Stars,0.5)
                     , modMean = mean(Stars)
                     , modci90lo = quantile(Stars, 0.025)
                     , modci90up = quantile(Stars, 0.975)
                     , ci = modci90up-modci90lo
                     , text = paste0(round(modMedian,2)," (",round(modci90lo,2)," to ",round(modci90up,2),")")
                     ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_if(is.numeric,round,2)
  
  kable(modRes %>%
          dplyr::select(Year,Age,Gender,modMean,`Median and range in 90% credible intervals`=text)
        , caption = "Summary of model results"
        )

```

```{r modResult, fig.cap = "Model results. Most reviewers give 5 stars irrespective of age or gender. The lower 95% credible intervals go to three stars in almost every case - i.e. more than 95% of responses are three stars or more. 18-24 year old males in 2017 are the main exception - they have a mean of 4 stars with 95% credible intervals stretching from 1-5"}

  ggplot(data=modRes,aes(Age,modMedian,group=Age)) +
    geom_point(aes(colour = Age)) +
    geom_ribbon(aes(ymin = modci90lo, ymax = modci90up, fill = Age), alpha = 0.6) +
    scale_colour_viridis_d() +
    scale_fill_viridis_d() +
    facet_grid(Gender~Park
               #, scales="free"
               ) +
    labs(y = "Median credible value for Stars"
         , subtitle = "Shading represents 95% credible intervals"
         )

```


# References
